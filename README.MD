# PR Reviewer Service

HTTP-сервис для управления пользователями, командами и пулл-реквестами, а также автоматического назначения ревьюверов.

Сервис предоставляет REST API для:
- регистрации пользователей и команд;
- создания pull request'ов;
- автоматического назначения ревьюверов по правилам;
- переназначения ревьювера.

## Архитектура

Сервис разделён на логические уровни:

- **api/** — HTTP-handlers, сериализация/десериализация JSON, управление HTTP-кодами.
- **internal/app/pr-reviewer-service/core/** — бизнес-логика:
    - назначение ревьюверов;
    - обработка ошибок;
    - переназначение ревьюверов.
- **internal/domain/** — сущности доменной модели: `User`, `Team`, `PullRequest`, а также доменные ошибки.
- **configs/** — конфигурационные файлы.
- **cmd/** — точка входа.

## Запуск сервиса
```bash
docker-compose up
```
Сервис поднимется на
```bash
http://localhost:8080
```

## Сборка локально и разработка

Сборка бинарника
```bash
make build
```

Запуск сервиса
```bash
make run
```

Запуск тестов
```bash
make test
```

Очистка артефактов сборки
```bash
make clean
```

Запуск линтера
```bash
make lint
```

Запуск форматера
```bash
make fmt
```

Обновление go.mod / go.sum
```bash
make tidy
```

## API
Endpoints реализованы вручную, без генераторов.

`POST /team/add` **Создать команду**

Создаёт команду с указанными участниками.
Если команда уже существует — возвращает ошибку.
`user_id` должен быть уникален в рамках всей системы.

`GET /team/get?team_name=NAME` **Получить команду**

Возвращает структуру команды и список её участников.

`POST /users/setIsActive` **Изменить активность пользователя**

Позволяет включить/выключить пользователя

`GET /users/getReview?user_id=u1` **Получить список PR, где пользователь — ревьювер**

Возвращает все PR в статусе _OPEN_ или _MERGED_, где пользователь был назначен ревьювером.

`POST /pullRequest/create` **Создать PR**

Создаёт Pull Request и автоматически назначает до двух ревьюверов

`POST /pullRequest/merge` **Пометить PR как MERGED**

Операция идемпотентна — можно вызывать повторно.
После merge ревьюверы сохраняются, добавляется mergedAt.

`POST /pullRequest/reassign` **Переназначить ревьювера**

Меняет конкретного ревьювера на другого, выбранного случайно

## E2E тесты

**1. Создание команды**

    `POST /team/add`  создаёт команду
    
    `GET /team/get?team_name=...`  достаёт команду

**2. Создание и мердж PR**
    
    `POST /team/add` создаёт команду
    
    `POST /pullRequest/create` создает PR
    
    `POST /pullRequest/merge` мержит PR

**3. Переназначение ревюера**
    
    `POST /team/add` создаёт команду
    
    `POST /pullRequest/create` создает PR
    
    `POST /pullRequest/reassign` переназначает ревюера

## Linter Configuration

Сервис использует **golangci-lint** с расширенной конфигурацией, включающей проверки качества кода, безопасности и стиля.  
Конфигурация расположена в `.golangci.yml`.

### Включённые линтеры

| Линтер | Назначение |
|--------|------------|
| **govet** | Стандартный анализатор Go, выявляет логические ошибки и подозрительные конструкции. |
| **staticcheck** | Один из самых мощных анализаторов кода: находит скрытые баги, устаревшие конструкции, неэффективности. |
| **gosec** | Проверяет код на потенциальные уязвимости безопасности. |
| **misspell** | Находит опечатки в комментариях и строках. |
| **errcheck** | Требует обязательную проверку ошибок всех функций. |
| **errname** | Проверяет, что переменные/типы ошибок оформлены по конвенции (`ErrX`, `XError`). |
| **errorlint** | Требует корректное обёртывание ошибок через `%w` и работу с `errors.Is`/`errors.As`. |
| **bodyclose** | Проверяет, что HTTP response body всегда закрыт. |
| **contextcheck** | Указывает на использование неподходящего или "отделённого" контекста. |
| **durationcheck** | Проверяет выражения, где перемножаются два duration (почти всегда ошибка). |
| **gocritic** | Большой набор проверок стиля, производительности и логики. |
| **ineffassign** | Находит присваивания переменной, значение которой позже не используется. |
| **nakedret** | Запрещает (implicit) return в функциях — требует явного указания значений. |
| **revive** | Мощный линтер на стиль кода, заменяет golint. |
| **prealloc** | Предлагает preallocate для slice, если это возможно. |
| **reassign** | Запрещает переназначение package-level переменных. |
| **unconvert** | Убирает ненужные преобразования типов. |
| **unused** | Ищет неиспользуемые функции, переменные, зависимости. |
| **wastedassign** | Поймает присваивания, результат которых не влияет на программу. |

### Частные настройки линтеров

#### **revive**

Отключены два правила, чтобы не спамить предупреждениями:

- `exported` — не требует комментарий для публичных типов/функций
- `package-comments` — не требует комментарий перед `package <name>`

#### **gocritic**

Включены расширенные режимы:

- `diagnostic`, `experimental`, `opinionated`, `performance`, `style`

Отключены проверки, которые могут мешать при обычной разработке:

- `hugeParam` — большие структуры в параметрах
- `rangeExprCopy` — копирование выражений в range
- `rangeValCopy` — копирование значений в range

#### **govet**

Отключён `fieldalignment`, так как он шумит и требует менять порядок полей ради экономии байтов.